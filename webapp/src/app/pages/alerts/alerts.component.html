<div class="animated fadeIn">

  <div class="col-md-12">
    <div class="card">
      <div class="card-header">
        <div class="row">
          <div class="col-10">
            <i class="fa fa-bell fa-lg text-alert"></i> <strong>Alerts</strong>
          </div>
          <div class="col-2">
            <button class="pull-right btn btn-sm btn-round btn-success" (click)="openAddAlertModal()">
              <i class="fa fa-plus-circle"></i>
            </button>
          </div>
        </div>
      </div>
      <div class="card-block">
        <ng-container *ngIf="!alerts.length">
          No alert yet...
          <div class="sk-double-bounce">
            <div class="sk-child sk-double-bounce1"></div>
            <div class="sk-child sk-double-bounce2"></div>
          </div>
        </ng-container>

        <!-- Table -->
        <div *ngIf="alerts.length > 0" class="table-responsive">
          <table class="table table-hover table-outline" [mfData]="alerts" #mf="mfDataTable" [mfRowsOnPage]="10">
            <thead class="thead-inverse">
            <tr>
              <th class="text-center">
                <mfDefaultSorter by="id"><i class="fa fa-sort"></i> Device</mfDefaultSorter>
              </th>
              <th class="text-center">
                <mfDefaultSorter by="properties"><i class="fa fa-sort"></i> Trigger</mfDefaultSorter>
              </th>
              <th class="text-center">
                <mfDefaultSorter by="properties"><i class="fa fa-sort"></i> Last triggered</mfDefaultSorter>
              </th>
              <th class="text-center">
                <mfDefaultSorter by="properties"><i class="fa fa-sort"></i> Updated at</mfDefaultSorter>
              </th>
              <th class="text-center">Action</th>
            </tr>
            </thead>
            <tbody>
            <tr *ngFor="let alert of mf.data; let i = index">
              <td class="text-center">
                <a [routerLink]="['/device-messages', alert.Device.id]">
                  <strong class="text-device">{{alert.Device.id}}</strong>
                  <span *ngIf="alert.Device.name" class="small">({{alert.Device.name}})</span>
                </a>
              </td>
              <td>
                <div class="small">
                  <span class="text-gray-dark">Key: {{alert.key}}</span>
                </div>
                <div class="small" *ngIf="alert.value_min">
                  <span class="text-gray-dark">Min value: {{alert.value_min}}</span>
                </div>
                <div class="small" *ngIf="alert.value_max">
                  <span class="text-gray-dark">Max value: {{alert.value_max}}</span>
                </div>
                <div class="small" *ngIf="alert.value_less">
                  <span class="text-gray-dark">Less than value: {{alert.value_less}}</span>
                </div>
                <div class="small" *ngIf="alert.value_more">
                  <span class="text-gray-dark">More than value: {{alert.value_more}}</span>
                </div>
                <div class="small" *ngIf="alert.value_exact">
                  <span class="text-gray-dark">Exact value: {{alert.value_exact}}</span>
                </div>
                <div class="small" *ngIf="alert.message">
                  <span class="text-gray-dark">Message: {{alert.message}}</span>
                </div>
              </td>
              <td class="text-center">
                <strong>{{alert.last_trigger ? (alert.last_trigger | amTimeAgo) : ''}}</strong>
              </td>
              <td class="text-center">
                <strong>{{alert.updatedAt ? (alert.updatedAt | amTimeAgo) : ''}}</strong>
              </td>
              <td class="text-center">
                <div class="btn-group-sm">
                  <button class="btn btn-outline-primary btn-round" tooltip="Edit alert"
                          (click)="openEditAlertModal(alert)"><i class="fa fa-pencil fa-lg"></i></button>
                  <button class="btn btn-outline-danger btn-round" tooltip="Delete alert"
                          (click)="openConfirmModal(alert)"><i class="fa fa-trash fa-lg"></i></button>
                </div>
              </td>
            </tr>
            </tbody>
            <tfoot>
            <tr>
              <td colspan="4">
                <mfBootstrapPaginator [rowsOnPageSet]="[5,10,15]"></mfBootstrapPaginator>
              </td>
            </tr>
            </tfoot>
          </table>
        </div>
        <!-- End Table -->

      </div>
    </div>
  </div>
</div>

<div bsModal #addAlertModal="bs-modal" class="modal fade" [config]="{ignoreBackdropClick: true}" tabindex="-1"
     role="dialog"
     aria-labelledby="addAlertModal" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <!-- Form Begin -->
    <div class="modal-content">
      <form class="form-horizontal" #addAlertForm="ngForm">
        <div class="modal-header">
          <h4 class="modal-title">Add new alert</h4>
          <button type="button" class="close" (click)="addAlertModal.hide()" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <!-- Add Alert -->
          <div class="col-md-12">
            <div class="form-group row">
              <label class="col-md-3 form-control-label">Device
                <small class="text-danger">(required)</small>
              </label>
              <div class="col-md-9">
                <angular2-multiselect name="selectDevices"
                                      [data]="selectDevices"
                                      [(ngModel)]="selectedDevices"
                                      [settings]="selectOneDeviceSettings"
                                      (onSelect)="newAlert.deviceId = $event.id; loadKeys($event.id)"
                                      (onDeSelect)="newAlert.deviceId = null; newAlert.key = null;"
                                      required="">
                </angular2-multiselect>
              </div>
            </div>
            <div class="form-group row" *ngIf="newAlert.deviceId">
              <label class="col-md-3 form-control-label">Key
                <small class="text-danger">(required)</small>
              </label>
              <div class="col-md-9">
                <angular2-multiselect name="selectKeys"
                                      [data]="selectKeys"
                                      [(ngModel)]="selectedKeys"
                                      [settings]="selectOneSettings"
                                      (onSelect)="newAlert.key = $event.id"
                                      (onDeSelect)="newAlert.key = null"
                                      required>
                </angular2-multiselect>
              </div>
            </div>
            <ng-container *ngIf="newAlert.deviceId && newAlert.key">
              <div class="form-group row">
                <label class="offset-1 col-md-3 form-control-label">Exact value
                </label>
                <div class="col-md-8">
                  <input type="text" class="form-control" placeholder="Exact value" name="newAlert.value_exact"
                         [(ngModel)]="newAlert.value_exact">
                </div>
              </div>

              <div class="form-group row">
                <label class="col-md-3 offset-1 form-control-label">Between</label>
                <div class="col-md-8">
                  <div class="row">
                    <div class="col-md-6">
                      <label class="form-control-label">Min value</label>
                      <input type="number" class="form-control" name="newAlert.value_min"
                             [(ngModel)]="newAlert.value_min">
                    </div>
                    <div class="col-md-6">
                      <label class="form-control-label">Max value</label>
                      <input type="number" class="form-control" name="newAlert.value_max"
                             [(ngModel)]="newAlert.value_max">
                    </div>
                  </div>
                </div>
              </div>
              <div class="form-group row">
                <label class="col-md-3 offset-1 form-control-label">Less than</label>
                <div class="col-md-8">
                  <input type="number" class="form-control" name="newAlert.value_min"
                         [(ngModel)]="newAlert.value_less">
                </div>
              </div>
              <div class="form-group row">
                <label class="col-md-3 offset-1 form-control-label">More than</label>
                <div class="col-md-8">
                  <input type="number" class="form-control" name="newAlert.value_max"
                         [(ngModel)]="newAlert.value_more">
                </div>
              </div>
              <hr class="offset-1">
              <div class="form-group row">
                <label class="offset-1 col-md-3 form-control-label">Custom message
                  <small>(optional)</small>
                </label>
                <div class="col-md-8">
                  <input type="text" class="form-control" placeholder="Message" name="newAlert.message"
                         [(ngModel)]="newAlert.message">
                </div>
              </div>
            </ng-container>
            <div class="form-group row" *ngIf="newAlert.deviceId && newAlert.key">
              <label class="col-md-3 form-control-label">Connectors
                <small class="text-danger">(required)</small>
              </label>
              <div class="col-md-9">
                <angular2-multiselect name="selectConnectors"
                                      [data]="selectConnectors"
                                      [(ngModel)]="selectedConnectors"
                                      [settings]="selectConnectorsSettings"
                                      (onSelect)="setConnectors()"
                                      (onDeSelect)="setConnectors()"
                                      required>
                </angular2-multiselect>
              </div>
            </div>
          </div>
          <!-- End Add Alert -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="addAlertModal.hide()">Close</button>
          <button class="btn btn-success" [disabled]="!addAlertForm.form.valid" (click)="addAlert()"><i
            class="fa fa-plus-circle"></i> Add alert
          </button>
        </div>
      </form>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div bsModal #editAlertModal="bs-modal" class="modal fade" [config]="{ignoreBackdropClick: true}" tabindex="-1"
     role="dialog"
     aria-labelledby="editAlertModal" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <!-- Form Begin -->
    <div class="modal-content">
      <form class="form-horizontal" #editAlertForm="ngForm">
        <div class="modal-header">
          <h4 class="modal-title">Edit alert</h4>
          <button type="button" class="close" (click)="editAlertModal.hide()" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <!-- Edit Alert -->
          <div class="col-md-12">
            <div class="form-group row">
              <label class="col-md-3 form-control-label">Device
                <small class="text-danger">(required)</small>
              </label>
              <div class="col-md-9">
                <angular2-multiselect name="selectDevices"
                                      [data]="selectDevices"
                                      [(ngModel)]="selectedDevices"
                                      [settings]="selectOneDeviceSettings"
                                      (onSelect)="alertToEdit.deviceId = $event.id; loadKeys($event.id)"
                                      (onDeSelect)="alertToEdit.deviceId = null; alertToEdit.key = null;"
                                      required="">
                </angular2-multiselect>
              </div>
            </div>
            <div class="form-group row" *ngIf="alertToEdit.deviceId">
              <label class="col-md-3 form-control-label">Key
                <small class="text-danger">(required)</small>
              </label>
              <div class="col-md-9">
                <angular2-multiselect name="selectKeys"
                                      [data]="selectKeys"
                                      [(ngModel)]="selectedKeys"
                                      [settings]="selectOneSettings"
                                      (onSelect)="alertToEdit.key = $event.id"
                                      (onDeSelect)="alertToEdit.key = null"
                                      required>
                </angular2-multiselect>
              </div>
            </div>
            <ng-container *ngIf="alertToEdit.deviceId && alertToEdit.key">
              <div class="form-group row">
                <label class="offset-1 col-md-3 form-control-label">Exact value
                </label>
                <div class="col-md-8">
                  <input type="text" class="form-control" placeholder="Exact value" name="alertToEdit.value_exact"
                         [(ngModel)]="alertToEdit.value_exact">
                </div>
              </div>
              <div class="form-group row">
                <label class="col-md-3 offset-1 form-control-label">Between</label>
                <div class="col-md-8">
                  <div class="row">
                    <div class="col-md-6">
                      <label class="form-control-label">Min value</label>
                      <input type="number" class="form-control" name="alertToEdit.value_min"
                             [(ngModel)]="alertToEdit.value_min">
                    </div>
                    <div class="col-md-6">
                      <label class="form-control-label">Max value</label>
                      <input type="number" class="form-control" name="alertToEdit.value_max"
                             [(ngModel)]="alertToEdit.value_max">
                    </div>
                  </div>
                </div>
              </div>
              <div class="form-group row">
                <label class="col-md-3 offset-1 form-control-label">Less than</label>
                <div class="col-md-8">
                  <input type="number" class="form-control" name="alertToEdit.value_min"
                         [(ngModel)]="alertToEdit.value_less">
                </div>
              </div>
              <div class="form-group row">
                <label class="col-md-3 offset-1 form-control-label">More than</label>
                <div class="col-md-8">
                  <input type="number" class="form-control" name="alertToEdit.value_max"
                         [(ngModel)]="alertToEdit.value_more">
                </div>
              </div>
            </ng-container>
            <div class="form-group row" *ngIf="alertToEdit.deviceId && alertToEdit.key">
              <label class="col-md-3 form-control-label">Connectors
                <small class="text-danger">(required)</small>
              </label>
              <div class="col-md-9">
                <angular2-multiselect name="selectConnectors"
                                      [data]="selectConnectors"
                                      [(ngModel)]="selectedConnectors"
                                      [settings]="selectConnectorsSettings"
                                      (onSelect)="setConnectors()"
                                      (onDeSelect)="setConnectors()"
                                      required>
                </angular2-multiselect>
              </div>
            </div>
          </div>
          <!-- End Edit Alert -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="editAlertModal.hide()">Close</button>
          <button class="btn btn-primary" [disabled]="!editAlertForm.form.valid" (click)="editAlert()"><i
            class="fa fa-check"></i> Update
          </button>
        </div>
      </form>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div bsModal #confirmModal="bs-modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="confirmModal"
     aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">Remove alert</h4>
        <button type="button" class="close" (click)="confirmModal.hide()" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        Are your sure you wish to delete this alert?
      </div>
      <div class="modal-footer">
        <button class="btn btn-sm btn-danger" (click)="removeAlert()">Delete</button>
        <button class="btn btn-sm btn-default" (click)="confirmModal.hide()">Cancel</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<toaster-container [toasterconfig]="toasterconfig"></toaster-container>
